<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hemicycle US Senate Members 2025 - Fixed Seat Overlap</title>
    <link rel="stylesheet" href="css/nav.css">
    <style>
        /* Original styles unchanged except padding added for small screens*/

        #search-container {
            margin: 15px 0;
        }
        .input-wrapper {
            position: relative;
            display: inline-block;
            width: 300px;
        }
        #search-input,
        #state-select, #party-select, #committee-select, #subcommittee-select {
            font-size: 14px;
            margin: 0;
            padding: 6px 28px 6px 8px;
            width: 100%;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        .clear-x {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 16px;
            color: #888;
            z-index: 1;
            user-select: none;
            display: none;
        }
        #clear-search {
            margin-left: 8px;
            padding: 6px 10px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: white;
        }
        .democrat {
            background-color: #0074D9; /* Blue for Democrats */
        }
        
        /* Inverted colors for selected seats */
        .democrat.selected {
            background-color: white;
            border-color: #0074D9;
            box-shadow: 0 0 0 1px #0074D9;
        }
        
        .republican.selected {
            background-color: white;
            border-color: #e43030;
            box-shadow: 0 0 0 1px #e43030;
        }
        
        /* Keep yellow highlight for search results */
        .highlight {
            box-shadow: 0 0 10px 3px yellow !important;
            border-color: gold !important;
        }
        .republican {
            background: #FF4136;
        }
        .vacant {
            background: #AAAAAA;
        }
        .highlight {
            box-shadow: 0 0 10px 3px yellow;
            border-color: gold;
            z-index: 10;
        }
        .summary {
            font-size: 16px;
            font-weight: bold;
            display: inline-block;
            margin: auto;
        }
        #header {
            margin: 10px 0px 0px 0px;
        }
        #state-options, #party-options, #committee-options, #subcommittee-options {
            width: 99%;
            left: 0;
            right: 0;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-top: none;
            background: white;
            z-index: 1000;
            display: none;
        }
        #chart {
            width: 100%;
            display: block;
            text-align: center;
        }
        #filter label {
            padding: 10px 0px;
        }
        @media only screen and (max-width: 400px) {
            #main {
                display: block;
            }
            .hemicycle {
                position: relative;
                height: 250px;
                width: 100vw;
                max-width: 375px;
                margin-bottom: 20px;
                /* Add padding left and right to avoid clipping*/
                padding-left: 25px;
                padding-right: 25px;
                left:50px;
                box-sizing: border-box;
            }
            .seat {
                position: absolute;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                border: 2px solid white;
                box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
                transform: translate(-50%, -50%);
                cursor: pointer;
                transition: opacity 0.3s;
            }
            body {
                flex-direction: column;
                align-items: center;
                height: 100vh;
                background: #f0f0f0;
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 10px;
                box-sizing: border-box;
            }
            #search-input, .input-wrapper, #clear-search{
                width: 100%;
                display: block;
                margin:10px 0px;
            }
        }@media only screen and (min-width: 400px) and (max-width: 600px) {
            #main {
                display: block;
            }
            .hemicycle {
                position: relative;
                height: 250px;
                width: 100vw;
                max-width: 375px;
                margin-bottom: 20px;
                /* Add padding left and right to avoid clipping*/
                padding-left: 25px;
                padding-right: 25px;
                box-sizing: border-box;
            }
            .seat {
                position: absolute;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                border: 2px solid white;
                box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
                transform: translate(-50%, -50%);
                cursor: pointer;
                transition: opacity 0.3s;
            }
            body {
                flex-direction: column;
                align-items: center;
                height: 100vh;
                background: #f0f0f0;
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 10px;
                box-sizing: border-box;
            }
            #search-input, .input-wrapper, #clear-search{
                width: 100%;
                display: block;
                margin:10px 0px;
            }
        }
        @media only screen and (max-width: 1200px) and (min-width: 600px) {
            #main {
                display: block;
            }
            .hemicycle {
                position: relative;
                height: 350px;
                width: 65vw;
                max-width: 480px;
                margin-bottom: 20px;
                padding-left: 20px;
                padding-right: 20px;
                box-sizing: border-box;
            }
            .seat {
                position: absolute;
                width: 10px;
                height: 10px;
                border-radius: 50%;
                border: 2px solid white;
                box-shadow: 0 0 3px rgba(0,0,0,0.3);
                transform: translate(-50%, -50%);
                cursor: pointer;
                transition: opacity 0.3s;
            }
            body {
                flex-direction: column;
                align-items: center;
                height: 100vh;
                background: #f0f0f0;
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 10px;
                box-sizing: border-box;
            }
            #search-input, .input-wrapper, #clear-search{
                width: 100%;
                display: block;
                margin:10px 0px;
            }
        }
        @media only screen and (min-width: 1200px) {
            #main {
                display: flex;
                width: 100%;
            }
            #filter{
                width: 25%;
                height: 100%;
                display: block;
                margin: 0px 10px;
            }
            .hemicycle {
                position: relative;
                height: 500px;
                width: 700px;
                margin-bottom: 20px;
                padding: 0;
                box-sizing: border-box;
            }
            .seat {
                position: absolute;
                width: 15px;
                height: 15px;
                border-radius: 50%;
                border: 2px solid white;
                box-shadow: 0 0 3px rgba(0,0,0,0.3);
                transform: translate(-50%, -50%);
                cursor: pointer;
                transition: opacity 0.3s;
            }
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
                height: 100vh;
                background: #f0f0f0;
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 10px;
                box-sizing: border-box;
            }
        }

        /* Add padding to body to prevent content from being hidden behind the fixed navbar */
        body {
            padding-top: 60px;
        }
    </style>
</head>
<body>
<nav>
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="house.html" class="active">House</a></li>
        <li><a href="committee.html">Committees</a></li>
        <li><a href="faq.html">FAQ</a></li>
    </ul>
</nav>
<h1 id="header">USA Congress - Senate 2025 - 119th Congress</h1>
<div id="search-container">
    <div class="input-wrapper">
        <input type="text" id="search-input" placeholder="Search representative by name..." />
        <span class="clear-x" id="clear-search-input">×</span>
    </div>
    <button id="clear-search">Clear/Reset All Filters</button>
</div>

<div id="main">
    <div id="filter">
        <label for="state-select">Select or type a state:</label><br />
        <div class="input-wrapper" style="width:100%;">
            <input type="text" id="state-select" placeholder="Start typing a state..." autocomplete="off" />
            <span class="clear-x" id="clear-state-input">×</span>
        </div>
        <div id="state-options"></div>
        <br />
        <label for="party-select">Select or type a party:</label><br />
        <div class="input-wrapper" style="width:100%;">
            <input type="text" id="party-select" placeholder="Type Party name" autocomplete="off" />
            <span class="clear-x" id="clear-party-input">×</span>
        </div>
        <div id="party-options"></div>
        <br />
        <label for="committee-select">Select or type a committee:</label><br />
        <div class="input-wrapper" style="width:100%;">
            <input type="text" id="committee-select" placeholder="Type committee name" autocomplete="off" />
            <span class="clear-x" id="clear-committee-input">×</span>
        </div>
        <div id="committee-options"></div>
        <label for="subcommittee-select">Select or type a subcommittee:</label><br />
        <div class="input-wrapper" style="width:100%;">
            <input type="text" id="subcommittee-select" placeholder="Type subcommittee name or code" autocomplete="off" />
            <span class="clear-x" id="clear-subcommittee-input">×</span>
        </div>
        <div id="subcommittee-options"></div>
        <div id="seatsHighlighted" style="text-align: center;vertical-align: bottom;padding: 10px;">Please filter or search to see count number of seats highlighted</div>
    </div>
    <div id="chart">
        <!-- Add this div below your chart div -->
        <div id="viewer-card" style="
          border: 1px solid #ccc;
          background: white;
          padding: 12px;
          margin-top: 20px;
          margin-left: auto;
          margin-right: auto;
          max-width: 300px;
          box-shadow: 0 0 8px rgba(0,0,0,0.15);
          font-family: Arial, sans-serif;
          display: none;
        ">
            <div style="display: flex; align-items: flex-start;">
                <div style="flex: 0 0 auto;">
                    <img id="viewer-portrait" src="" alt="Portrait" style="width:80px;height:100px;object-fit:cover;border-radius:8px;border:1px solid #ccc;display:block;">
                </div>
                <div style="flex: 1 1 0; margin-left: 18px;">
                    <h3 id="viewer-name" style="margin: 0 0 6px 0;"></h3>
                    <p id="viewer-party" style="margin: 4px 0;"></p>
                    <p id="viewer-state" style="margin: 4px 0;"></p>
                    <button id="viewer-link" style="background-color: #000000;color: white;border: none;padding: 8px 16px;border-radius: 4px;cursor: pointer;font-size: 14px;width:100%;">View Full Details</button>
                </div>
            </div>
        </div>
        <div class="hemicycle" id="hemicycle" style="margin: 0 auto;"></div>
        <br>
        <div class="summary" id="summary"></div>
        <div class="simpleMar" id="simpleMar"></div>
    </div>
</div>

<div>
    <h2>How to use?</h2>
    <ul>
        <li>Enter the name of the person who represents your state in the Senate.</li>
        <li>Or pick or type the name of your state on the left side (if you're on a computer) or at the top of the chart (if you're on a phone). You can also just type the state's abbreviation.</li>
        <li>Doing one of these things will make all the other names fade out and highlight only your chosen senator(s).</li>
        <li>Click or tap on the seat or dot to get viewer card which appears with stats of the senator</li>
        <li>Click or tap "View Full Details" in the viewer card</li>
    </ul>
    <h2>Explain looks</h2>
    <ul>
        <li>Red dots = Republicans</li>
        <li>Blue dots = Democrats</li>
        <li>Republicans are on left and Democrats on right to reflect where they sit in real life.</li>
    </ul>
</div>
<script>
    // Declare all constants once globally
    const ABBR_TO_FULL = {AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",FL:"Florida",GA:"Georgia",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming"};
    const STATE_FULL_NAMES = {...ABBR_TO_FULL, DC:"District of Columbia"};
    const VOTING_STATES = new Set(Object.keys(ABBR_TO_FULL));
    const ALL_PARTY_OPTIONS = ["Democrat", "Republican"];

    // Wait DOM and perform main logic
    (() => {
        // Cached element refs
        const stateInput = document.getElementById('state-select');
        const stateOptions = document.getElementById('state-options');
        const partyInput = document.getElementById('party-select');
        const partyOptions = document.getElementById('party-options');
        const searchInput = document.getElementById('search-input');
        const clearSearchX = document.getElementById('clear-search-input');
        const clearStateX = document.getElementById('clear-state-input');
        const clearPartyX = document.getElementById('clear-party-input');
        const clearSearchBtn = document.getElementById('clear-search');
        const committeeInput = document.getElementById('committee-select');
        const committeeOptions = document.getElementById('committee-options');
        const clearCommitteeX = document.getElementById('clear-committee-input');
        const subcommitteeInput = document.getElementById('subcommittee-select');
        const subcommitteeOptions = document.getElementById('subcommittee-options');
        const clearSubcommitteeX = document.getElementById('clear-subcommittee-input');

        const hemicycle = document.getElementById('hemicycle');
        const tooltip = document.getElementById('tooltip');
        const summary = document.getElementById('summary');
        const simpleMar = document.getElementById('simpleMar');
        const seatsHighlighted = document.getElementById('seatsHighlighted');
        const viewerCard = document.getElementById('viewer-card');
        const viewerName = document.getElementById('viewer-name');
        const viewerParty = document.getElementById('viewer-party');
        const viewerState = document.getElementById('viewer-state');
        const viewerLink = document.getElementById('viewer-link');

        const numberRows=11, fullRadius=250, fullGap=25;
        let members = [], seatEls = [];

        let committeeMembershipData = {};
        let committeesData = [];
        let committeeNames = [];
        let subcommitteeNames = [];

        function partyClass(p){ return p==='Democrat'?'democrat':p==='Republican'?'republican':'vacant'; }

        function showOptions(container, items, onClick){
            container.innerHTML='';
            items.forEach(item => {
                const d = document.createElement('div');
                d.textContent = item;
                d.style.padding = '6px 8px';
                d.style.cursor = 'pointer';
                d.onmousedown = () => { onClick(item); }
                d.onmouseover = () => { d.style.background = '#0074D9'; d.style.color = '#fff'; }
                d.onmouseout = () => { d.style.background = '#fff'; d.style.color = '#000'; }
                container.appendChild(d);
            });
            container.style.display = items.length ? 'block' : 'none';
        }

        // State input handlers
        stateInput.addEventListener('input', () => {
            const v = stateInput.value.trim().toLowerCase();
            if (!v) {
                showOptions(stateOptions, Object.entries(ABBR_TO_FULL).map(([abbr,name]) => `${abbr} - ${name}`), selectState);
                filterSeats();
                toggleClear();
                return;
            }
            showOptions(stateOptions, Object.entries(ABBR_TO_FULL).map(([abbr,name]) => `${abbr} - ${name}`).filter(o => {
                const [abbr, name] = o.split(' - ');
                return abbr.toLowerCase().startsWith(v) || name.toLowerCase().startsWith(v);
            }), selectState);
            filterSeats();
            toggleClear();
        });
        stateInput.addEventListener('focus', () => {
            showOptions(stateOptions, Object.entries(ABBR_TO_FULL).map(([abbr,name]) => `${abbr} - ${name}`), selectState);
        });
        stateInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                const val = stateInput.value.trim().toUpperCase();
                if (ABBR_TO_FULL[val]) {
                    stateInput.value = ABBR_TO_FULL[val];
                    stateOptions.style.display = 'none';
                    filterSeats();
                    toggleClear();
                    e.preventDefault();
                }
            }
        });
        stateInput.addEventListener('blur', () => {
            setTimeout(() => stateOptions.style.display = 'none', 100);
        });

        function selectState(item) {
            const abbr = item.split(' - ')[0];
            if (ABBR_TO_FULL[abbr]) {
                stateInput.value = ABBR_TO_FULL[abbr];
                stateOptions.style.display = 'none';
                filterSeats();
                toggleClear();
            }
        }


        // Party input handlers
        partyInput.addEventListener('focus', () => showOptions(partyOptions, ALL_PARTY_OPTIONS, selectParty));
        partyInput.addEventListener('input', () => {
            const v = partyInput.value.trim().toLowerCase();
            if (!v) {
                showOptions(partyOptions, ALL_PARTY_OPTIONS, selectParty);
                filterSeats();
                toggleClear();
                return;
            }
            showOptions(partyOptions, ALL_PARTY_OPTIONS.filter(o => o.toLowerCase().startsWith(v)), selectParty);
            filterSeats();
            toggleClear();
        });
        partyInput.addEventListener('blur', () => {
            setTimeout(() => partyOptions.style.display = 'none', 100);
        });
        function selectParty(item) {
            partyInput.value = item;
            partyOptions.style.display = 'none';
            filterSeats();
            toggleClear();
        }

        // Committee input handlers
        committeeInput.addEventListener('focus', () => showOptions(committeeOptions, ALL_PARTY_OPTIONS, selectCommittee));
        committeeInput.addEventListener('input', () => {
            const v = committeeInput.value.trim().toLowerCase();
            if (!v) {
                showOptions(committeeOptions, ALL_PARTY_OPTIONS, selectCommittee);
                filterSeats();
                toggleClear();
                return;
            }
            showOptions(committeeOptions, ALL_PARTY_OPTIONS.filter(o => o.toLowerCase().startsWith(v)), selectCommittee);
            filterSeats();
            toggleClear();
        });
        committeeInput.addEventListener('blur', () => {
            setTimeout(() => committeeOptions.style.display = 'none', 100);
        });
        function selectCommittee(item) {
            committeeInput.value = item;
            committeeOptions.style.display = 'none';
            filterSeats();
            toggleClear();
        }

        // Subcommittee input handlers
        subcommitteeInput.addEventListener('focus', () => {
            showOptions(subcommitteeOptions, getFilteredSubcommittees(), selectSubcommittee);
        });
        subcommitteeInput.addEventListener('input', () => {
            const v = subcommitteeInput.value.trim().toLowerCase();
            const filtered = getFilteredSubcommittees().filter(o => o.toLowerCase().includes(v));
            showOptions(subcommitteeOptions, filtered, selectSubcommittee);
            filterSeats();
            toggleClear();
        });
        subcommitteeInput.addEventListener('blur', () => {
            setTimeout(() => subcommitteeOptions.style.display = 'none', 100);
        });
        function selectSubcommittee(item) {
            subcommitteeInput.value = item;
            subcommitteeOptions.style.display = 'none';
            filterSeats();
            toggleClear();
        }

        clearStateX.onclick = () => { stateInput.value = ''; filterSeats(); toggleClear(); stateInput.focus(); }
        clearPartyX.onclick = () => { partyInput.value = ''; filterSeats(); toggleClear(); partyInput.focus(); }
        
        clearCommitteeX.onclick = () => { committeeInput.value = ''; filterSeats(); toggleClear(); committeeInput.focus(); }
        clearSubcommitteeX.onclick = () => { subcommitteeInput.value = ''; filterSeats(); toggleClear(); subcommitteeInput.focus(); }
        clearSearchX.onclick = () => { searchInput.value = ''; filterSeats(); toggleClear(); searchInput.focus(); }
        
        // Clear all filters and highlights
        clearSearchBtn.onclick = () => {
            searchInput.value = stateInput.value = partyInput.value = committeeInput.value = subcommitteeInput.value = '';
            // Remove all highlights and selected states when clearing
            seatEls.forEach(({ seat }) => {
                seat.classList.remove('highlight');
                seat.classList.remove('selected');
                seat.style.opacity = '1';
            });
            viewerCard.style.display = 'none';
            // Directly set the highlighted seats count to show all seats
            seatsHighlighted.textContent = `Number of seats highlighted: ${seatEls.length}`;
            toggleClear();
            searchInput.focus();
        }
        searchInput.addEventListener('input', () => { filterSeats(); toggleClear(); });
        stateInput.addEventListener('input', () => { filterSeats(); toggleClear(); });

        function toggleClear() {
            clearSearchX.style.display = searchInput.value ? 'block' : 'none';
            clearStateX.style.display = stateInput.value ? 'block' : 'none';
            clearPartyX.style.display = partyInput.value ? 'block' : 'none';
            clearCommitteeX.style.display = committeeInput.value ? 'block' : 'none';
            clearSubcommitteeX.style.display = subcommitteeInput.value ? 'block' : 'none';
        }

        // Fetch members data and prepare seats
        function fetchAndPrepareMembers() {
            Promise.all([
                fetch('https://unitedstates.github.io/congress-legislators/legislators-current.json').then(r=>r.json()),
                fetch('https://unitedstates.github.io/congress-legislators/committee-membership-current.json').then(r=>r.json()),
                fetch('https://unitedstates.github.io/congress-legislators/committees-current.json').then(r=>r.json())
            ]).then(([data, committeeMembershipData, committeesData]) => {
                const now = new Date();
                members = data.filter(m => {
                    if (!m.terms?.length) return false;
                    const t = m.terms[m.terms.length - 1];
                    return t.type === 'sen' && (!t.end || new Date(t.end) > now) && VOTING_STATES.has(t.state);
                }).sort((a, b) => {
                    const aT = a.terms[a.terms.length - 1], bT = b.terms[b.terms.length - 1];
                    return aT.state.localeCompare(bT.state);
                });
                // Annotate each member with their committee/subcommittee assignments
                members.forEach(member => {
                    member.committees = [];
                    const bioguide = member.id.bioguide;
                    for (const commId in committeeMembershipData) {
                        // Only keep house and joint committees/subcommittees
                        if (/^[A-Z]{4}$/.test(commId)) {
                            const commObj = committeesData.find(c => c.thomas_id === commId && (c.type === 'house' || c.type === 'joint'));
                            if (commObj) {
                                committeeMembershipData[commId].forEach(m => {
                                    if (m.bioguide === bioguide) {
                                        member.committees.push({ name: commObj.name, isSubcommittee: false });
                                    }
                                });
                            }
                        }
                        // Subcommittee: four-letter acronym + number
                        else if (/^[A-Z]{4}\d+$/.test(commId)) {
                            const parentId = commId.slice(0, 4);
                            const subId = commId.slice(4);
                            const commObj = committeesData.find(c => c.thomas_id === parentId && (c.type === 'house' || c.type === 'joint'));
                            if (commObj && commObj.subcommittees) {
                                const subObj = commObj.subcommittees.find(s => s.thomas_id === subId);
                                if (subObj) {
                                    committeeMembershipData[commId].forEach(m => {
                                        if (m.bioguide === bioguide) {
                                            member.committees.push({ name: commObj.name + ' - ' + subObj.name, isSubcommittee: true });
                                        }
                                    });
                                }
                            }
                        }
                    }
                });
                // Build committee and subcommittee names for dropdown
                committeeNames = [];
                subcommitteeNames = [];
                committeesData.forEach(comm => {
                    if ((comm.type === 'senate' || comm.type === 'joint') && comm.name) committeeNames.push(comm.name);
                    if ((comm.type === 'senate' || comm.type === 'joint') && comm.subcommittees) {
                        comm.subcommittees.forEach(sub => {
                            if(sub.name) {
                                const subId = comm.thomas_id + sub.thomas_id;
                                subcommitteeNames.push({
                                    display: comm.name + ' - ' + sub.name,
                                    value: subId,
                                    parent: comm.name
                                });
                            }
                        });
                    }
                });
                committeeNames = Array.from(new Set(committeeNames)).sort();
                // Setup committee filter options
                committeeInput.addEventListener('focus', () => showOptions(committeeOptions, committeeNames, selectCommittee));
                committeeInput.addEventListener('input', () => {
                    const v = committeeInput.value.trim().toLowerCase();
                    if (!v) {
                        showOptions(committeeOptions, committeeNames, selectCommittee);
                        selectedCommittee = '';
                        showOptions(subcommitteeOptions, getFilteredSubcommittees(), selectSubcommittee);
                        filterSeats();
                        toggleClear();
                        return;
                    }
                    const filteredCommittees = committeeNames.filter(o => o.toLowerCase().includes(v));
                    showOptions(committeeOptions, filteredCommittees, selectCommittee);
                    selectedCommittee = filteredCommittees.length === 1 && committeeInput.value.trim().toLowerCase() === filteredCommittees[0].toLowerCase() ? filteredCommittees[0] : '';
                    showOptions(subcommitteeOptions, getFilteredSubcommittees(), selectSubcommittee);
                    filterSeats();
                    toggleClear();
                });
                function selectCommittee(item) {
                    committeeInput.value = item;
                    committeeOptions.style.display = 'none';
                    selectedCommittee = item;
                    showOptions(subcommitteeOptions, getFilteredSubcommittees(), selectSubcommittee);
                    filterSeats();
                    toggleClear();
                }
                function getFilteredSubcommittees() {
                    if (!selectedCommittee) return subcommitteeNames.map(s=>s.display);
                    return subcommitteeNames.filter(s => s.parent === selectedCommittee).map(s=>s.display);
                }
                subcommitteeInput.addEventListener('focus', () => {
                    showOptions(subcommitteeOptions, getFilteredSubcommittees(), selectSubcommittee);
                });
                subcommitteeInput.addEventListener('input', () => {
                    const v = subcommitteeInput.value.trim().toLowerCase();
                    const filtered = getFilteredSubcommittees().filter(o => o.toLowerCase().includes(v));
                    showOptions(subcommitteeOptions, filtered, selectSubcommittee);
                    filterSeats();
                    toggleClear();
                });
                function selectSubcommittee(item) {
                    subcommitteeInput.value = item;
                    subcommitteeOptions.style.display = 'none';
                    filterSeats();
                    toggleClear();
                }
                drawHemicycle(); // Always render chart after data loads
                updateSummary();
                toggleClear();
            }).catch(e => {
                console.error('Failed to load data:', e);
                hemicycle.textContent = 'Failed to load data.';
            });
        }

        // Distribute seats with fewer seats in inner rows to prevent overlap
        function distributeSeats(total) {
            // For small numbers, distribute with very few in inner rows
            if (total <= 15) return [1, 2, Math.ceil(total/3), Math.ceil(total/2), total];

            // For medium numbers, use a more gradual distribution
            if (total <= 30) {
                const base = Math.floor(total / 6);
                return [1, base + 1, base * 2, base * 3, total - (base * 6) + base * 3];
            }

            // For larger numbers, use a more aggressive distribution
            const dist = [
                Math.max(1, Math.floor(total * 0.05)),  // 5% in first row
                Math.max(2, Math.floor(total * 0.15)),  // 15% in second row
                Math.max(4, Math.floor(total * 0.25)),  // 25% in third row
                Math.max(6, Math.floor(total * 0.25)),  // 25% in fourth row
                0  // Remainder will be calculated
            ];

            // Calculate remaining seats for the outer row
            const used = dist.reduce((a, b) => a + b, 0);
            dist[4] = Math.max(0, total - used);

            return dist;
        }

        // Draw the hemicycle with seats by party and row
        function drawHemicycle() {
            hemicycle.innerHTML = '';
            seatEls = [];
            const w = hemicycle.clientWidth, h = hemicycle.clientHeight;
            const scale = (w - 50) / 500; // Adjusted scale for smaller number of seats
            const startR = 50 * scale; // Start radius
            const rowGap = 50 * scale; // Gap between rows
            const numberRows = 5; // Reduced number of rows for Senate
            const radii = Array.from({ length: numberRows }, (_, i) => startR + i * rowGap);
            // Center point adjusted higher for flat bottom hemicycle
            const cx = w / 2, cy = h * 0.8;
            const totalArc = Math.PI;

            // Hemicycle with flat bottom
            const baseGap = 0.05 * scale;

            // Hemicycle layout with larger gap between parties
            const gap = Math.PI * 0.2; // 20% gap between parties (increased from 10%)

            // Republicans on the right (from 0 to (π - gap) * 0.5)
            const repStart = 0;
            const repEnd = (Math.PI - gap) * 0.5;

            // Democrats on the left (from (π + gap) * 0.5 to π)
            const demStart = (Math.PI + gap) * 0.5;
            const demEnd = Math.PI;

            // Filter members by party and handle caucusing
            const reps = [];
            const dems = [];
            const others = [];
            
            members.forEach(member => {
                const term = member.terms[member.terms.length - 1];
                
                if (term.party === 'Republican' || 
                    (term.party === 'Independent' && term.caucus === 'Republican')) {
                    reps.push(member);
                } 
                else if (term.party === 'Democrat' || 
                        (term.party === 'Independent' && 
                         (term.caucus === 'Democrat' || !term.caucus))) {
                    // Default Independents to Democrat side if no caucus specified
                    dems.push(member);
                } else {
                    // Any other cases go to others
                    others.push(member);
                }
            });
            
            // Log any members that didn't fit the main categories
            if (others.length > 0) {
                console.log('Members not in main parties:', others.map(m => ({
                    name: `${m.name.first} ${m.name.last}`,
                    party: m.terms[m.terms.length - 1].party,
                    caucus: m.terms[m.terms.length - 1].caucus
                })));
            }

            // Distribute seats for each party
            const repSeats = distributeSeats(reps.length);
            const demSeats = distributeSeats(dems.length);

            function drawParty(mems, seatsPerRow, startA, endA) {
                let idx = 0;

                for (let r = 0; r < numberRows; r++) {
                    const rad = radii[r], sc = seatsPerRow[r];
                    if (!sc || idx >= mems.length) continue;

                    // Calculate seat size based on row (smaller for inner rows)
                    const seatSize = Math.max(scale * 10 * (0.8 + (r * 0.1)), 8);

                    // Calculate angle range and step for this row with padding
                    const angleRange = Math.abs(endA - startA);
                    const minAngle = (seatSize * 1.5) / rad; // Minimum angle to prevent overlap
                    const maxSeats = Math.max(1, Math.floor(angleRange / minAngle));
                    const actualSeats = Math.min(sc, maxSeats, mems.length - idx);
                    const step = actualSeats > 1 ? angleRange / (actualSeats - 1) : 0;

                    for (let i = 0; i < sc && idx < mems.length; i++) {
                        const m = mems[idx];
                        const p = m.terms[m.terms.length - 1].party;
                        const cls = partyClass(p);

                        // Calculate angle for this seat
                        const angle = startA + (step * i);

                        // Calculate position in semicircle
                        const x = cx + rad * Math.cos(angle);
                        const y = cy - rad * Math.sin(angle);

                        const seat = document.createElement('div');
                        seat.className = 'seat ' + cls;
                        seat.style.left = x + 'px';
                        seat.style.top = y + 'px';
                        seat.title = `${m.name.first} ${m.name.last} (${p})`;
                        seat.style.width = seat.style.height = seatSize + 'px';
                        seat.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';

                        seat.onclick = e => {
                            e.stopPropagation();
                            updateViewerCard(m);
                            seatEls.forEach(({ seat: s }) => {
                                s.classList.remove('selected');
                            });
                            seat.classList.add('selected');
                        };

                        hemicycle.appendChild(seat);
                        seatEls.push({ seat, member: m });
                        idx++;
                    }
                }
            }
            // Draw Republicans (right side) and Democrats (left side)
            drawParty(reps, repSeats, repStart, repEnd);
            drawParty(dems, demSeats, demStart, demEnd);
        }

        function updateViewerCard(m) {
            const t = m.terms[m.terms.length - 1];
            const stateName = STATE_FULL_NAMES[t.state] || t.state;
            viewerName.textContent = `${m.name.first} ${m.name.last}`;
            viewerParty.textContent = `Party: ${t.party}`;
            viewerState.textContent = `State: ${stateName}`;
            const url = `representative.html?${m.id.bioguide}?source=senate`;
            viewerLink.onclick = () => window.location.href = url;
            document.getElementById('viewer-portrait').src = `https://raw.githubusercontent.com/argentargenticle/USA_Senate_Images/main/${m.id.bioguide}.jpg`;
            // Reset styles first
            viewerCard.style.backgroundColor = 'white';
            viewerCard.style.color = 'black';
            viewerCard.style.borderLeft = 'none';

            if (t.party.toLowerCase() === 'democrat') {
                viewerCard.style.borderLeft = '6px solid #0074D9';
            } else if (t.party.toLowerCase() === 'republican') {
                viewerCard.style.borderLeft = '6px solid #e43030';
            }
            viewerCard.style.display = 'block';
        }
        document.addEventListener('click', (e) => {
            // Only hide if clicking outside the viewer card
            if (!viewerCard.contains(e.target)) {
                viewerCard.style.display = 'none';
                seatEls.forEach(({ seat: s }) => {
                    s.classList.remove('selected');
                    // Don't remove highlight here to keep search results visible
                });
            }
        });

        function updateSummary() {
            let dc = 0, rc = 0, id = 0, ir = 0; // dc: democrats, rc: republicans, id: independents with dems, ir: independents with reps
            members.forEach(m => {
                const term = m.terms[m.terms.length - 1];
                if (term.party === 'Democrat') {
                    dc++;
                } else if (term.party === 'Republican') {
                    rc++;
                } else if (term.party === 'Independent') {
                    if (term.caucus === 'Republican') {
                        ir++;
                    } else {
                        // Default to caucusing with Democrats if not specified
                        id++;
                    }
                }
            });
            const filled = dc + rc + id + ir, vac = 100 - filled;
            
            // Format party counts with their respective independents
            const repTotal = rc + ir;
            const demTotal = dc + id;
            
            let repText = repTotal.toString();
            let demText = demTotal.toString();
            
            // Add independent counts in parentheses if they exist
            if (ir > 0) {
                repText = `${repTotal} (Rep:${rc} | Ind:${ir})`;
            }
            if (id > 0) {
                demText = `${demTotal} (Dem:${dc} | Ind:${id})`;
            }
            summary.innerHTML = `Republicans: ${rc} — Democrats: ${demText} — Vacant: ${vac}` +
                (vac > 0 ? ' — <a href="https://ballotpedia.org/Special_elections_to_the_119th_United_States_Congress_(2025-2026)" target="_blank">See upcoming special elections</a>' : '');
            simpleMar.innerText = `Simple Majority (of ${filled} filled seats): ${Math.floor(filled / 2) + 1}`;
        }

        function updateHighlightedSeatsCount() {
            seatsHighlighted.textContent = "Number of seats highlighted: " + document.querySelectorAll('.seat.highlight').length;
        }

        function normalizeName(name) {
            return name.replace(/\s+/g, ' ').trim().toLowerCase();
        }

        function filterSeats() {
            const sFilter = stateInput.value.trim().toUpperCase();
            const pFilter = partyInput.value.trim().toLowerCase();
            const cFilterRaw = committeeInput.value.trim();
            const cFilter = normalizeName(cFilterRaw);
            const nFilter = searchInput.value.toLowerCase().trim();
            const subcFilterRaw = subcommitteeInput.value.trim();
            const subcFilter = subcFilterRaw.toLowerCase();
            
            // Update clear button visibility for inputs
            clearPartyX.style.display = pFilter ? 'block' : 'none';
            clearCommitteeX.style.display = cFilterRaw ? 'block' : 'none';
            clearSubcommitteeX.style.display = subcFilterRaw ? 'block' : 'none';

            const stateMap = Object.fromEntries(Object.entries(ABBR_TO_FULL).map(([k, v]) => [v.toUpperCase(), k]));
            let stFilter = "";
            if (sFilter.length === 2 && VOTING_STATES.has(sFilter)) stFilter = sFilter;
            else if (stateMap[sFilter]) stFilter = stateMap[sFilter];

            seatEls.forEach(({ seat, member }) => {
                const t = member.terms[member.terms.length - 1];
                const ms = t.state.toUpperCase();
                const mp = t.party.toLowerCase();
                const fn = (member.name.first + " " + member.name.last).toLowerCase();

                const sMatch = !stFilter || ms === stFilter;
                const nMatch = !nFilter || fn.includes(nFilter);
                const pMatch = !pFilter || mp === pFilter;
                let cMatch = true;
                if (cFilter && member.committees) {
                    // Highlight if matches committee or any subcommittee under it
                    cMatch = member.committees.some(comm => {
                        const commName = normalizeName(comm.name);
                        if (!comm.isSubcommittee && commName === cFilter) return true;
                        if (comm.isSubcommittee && commName.startsWith(cFilter + ' - ')) return true;
                        if (comm.isSubcommittee && commName === cFilter) return true;
                        return false;
                    });
                }
                let subcMatch = true;
                if (subcFilter && member.committees) {
                    subcMatch = member.committees.some(comm => {
                        // Match subcommittee by display name
                        return comm.isSubcommittee && comm.name.toLowerCase().includes(subcFilter);
                    });
                }
                if (sMatch && nMatch && pMatch && cMatch && subcMatch) {
                    seat.style.opacity = '1';
                    seat.classList.add('highlight');
                } else {
                    seat.style.opacity = '0.15';
                    seat.classList.remove('highlight');
                }
            });

            updateHighlightedSeatsCount();

            // Clear all highlights when all filters are cleared
            if (nFilter === '' && !stFilter && !dFilter && !pFilter && !cFilter) {
                seatEls.forEach(({ seat }) => {
                    seat.classList.remove('highlight');
                });
                return;
            }

            let found = false;
            seatEls.forEach(({ seat, member }) => {
                const fn = (member.name.first + " " + member.name.last).toLowerCase();
                const ms = member.terms[member.terms.length - 1].state.toUpperCase();
                if (fn === nFilter && (!stFilter || ms === stFilter)) {
                    seat.style.opacity = '1';
                    seat.classList.add('highlight');
                    found = true;
                }
            });

            if (!found) {
                seatEls.forEach(({ seat, member }) => {
                    const fn = (member.name.first + " " + member.name.last).toLowerCase();
                    const ms = member.terms[member.terms.length - 1].state.toUpperCase();
                    if (fn.includes(nFilter) && (!stFilter || ms === stFilter)) {
                        seat.classList.add('highlight');
                    }
                });
            }
        }

        fetchAndPrepareMembers();
    })();
</script>
</body>
</html>